{% comment %}
Custom template for same-page post-AJAX submit share ask.
{% endcomment %}

{% load actionkit_tags %}

{% if page.custom_fields.after_action_next_step != "page-redirect" %}

<style>
	[aria-hidden="true"] {
  	display:none;}

	.afteraction-progress-meter-step{
		margin:0 0.6em;}
	.afteraction-progress-meter-dot{
		align-items:center;
		border:2px solid rgba(255,255,255,0.7);
		border-radius:2em;
		display:inline-block;
		display:inline-flex;
		height:1.4em;
		justify-content:center;
		margin-right:0.25em;
		vertical-align:bottom;
		width:1.4em;}
	.afteraction-progress-meter-dot.complete{
		border-color:#29ce31;
		background-color:#29ce31;}
	.afteraction-progress-meter-dot.declined{
		border-color:transparent;
		background-color:rgba(255,255,255,0.4);}
</style>

<div id="afteraction-progress-meter" aria-hidden="true" class="section text-small text-strong width-wide text-center padding-tiny bg-dkgray-trans" style="display:none;position:fixed;top:0;left:0;width:100%;z-index:10;">
	<span id="afteraction-progress-meter-step1" class="afteraction-progress-meter-step">
		<span class="afteraction-progress-meter-dot complete icon" data-icon="&#xE942;"></span> Sign</span>
	</span>
	<span id="afteraction-progress-meter-step2" class="afteraction-progress-meter-step">
		<span class="afteraction-progress-meter-dot icon" data-icon=""></span> Share</span>
	</span>
	<span id="afteraction-progress-meter-step3" class="afteraction-progress-meter-step">
		<span class="afteraction-progress-meter-dot icon" data-icon=""></span> Donate</span>
	</span>
</div>

<div id="afteraction">
	<div id="afteraction-share" class="section afteraction-panel border-top title-section padding-medium width-narrow text-center bg-{% if page.custom_fields.page_background_color %}{{ page.custom_fields.page_background_color }}{% else %}white{% endif %}" aria-live="polite" style="display:none;">
		<div id="afteraction-share-inner" class="section-inner"></div>
	</div>
	<div id="afteraction-donate" class="section afteraction-panel border-top title-section padding-medium width-narrow text-center bg-{% if page.custom_fields.page_background_color %}{{ page.custom_fields.page_background_color }}{% else %}white{% endif %}" aria-live="polite" style="display:none;">
		<div id="afteraction-donate-inner" class="section-inner"></div>
	</div>
</div>


<div id="afteraction-share-ask-source" aria-hidden="true">
	<div class="afteraction-share-ask-intro text-style-lead3 text-large3 text-lineheight-small text-strong margin-bottom-large">
	{% if page.custom_fields.share_slide_title %}
		<h2>{{ page.custom_fields.share_slide_title }}</h2>
	{% endif %}
	{% if page.custom_fields.share_slide_body %}
		<p>{{ page.custom_fields.share_slide_body }}</p>
	{% else %}
		<p>{% include_tmpl form.thank_you_text %}</p>
	{% endif %}
		<p>
	{% if page.custom_fields.afteraction_share_ask %}
		{{ page.custom_fields.afteraction_share_ask }}
	{% else %}
		{% filter ak_text:"afteraction_share_ask" %}Will you share this to get more people involved?{% endfilter %}
	{% endif %}
		</p>
		<p>
			<button class="afteraction-share-ask-yes button button-large margin-bottom-large">{% filter ak_text:"afteraction_share_ask_yes" %}Yes, I can share this{% endfilter %}</button>
			<button class="afteraction-share-ask-no button button-large margin-bottom-large">{% filter ak_text:"afteraction_share_ask_no" %}No, not now{% endfilter %}</button>
		</p>
	</div>
</div>

<div id="afteraction-share-source" aria-hidden="true" style="display:none;">
	<div class="afteraction-share-intro text-style-lead3 text-large3 text-lineheight-small text-strong margin-bottom-large">
		<p>{% filter ak_text:"afteraction_share_instructions" %}Thank you — Click below to share:{% endfilter %}</p>
	</div>

	<div class="fb-preview bg-white border margin-bottom-large">
{% if page.followup.share_image_value %}
		<div class="fb-preview-share-image image-link-parent">
			<img src="{{ page.followup.share_image_value }}">
		</div>
{% endif %}
		<div class="fb-preview-share-text padding-tiny text-left">
			<p class="fb-preview-share-title- strong margin-bottom-small">{{ page.followup.share_title_value }}</p>
			<p class="fb-preview-share-description- text-small">{{ page.followup.share_description_value }}</p>
			<p class="text-small2 text-font-secondary text-caps">350.org</p>
		</div>
	</div>
	<div>
		<a class="afteraction-share-button fb-share button button-share-facebook button-big arrow-right"  href="/share/link?type=fb&amp;page_name={{page.name}}&amp;action_id={{action.id}}&amp;akid={{akid}}">{% filter ak_text:"general_share_on_fb" %}Share on Facebook{% endfilter %}</a>
	</div>
</div>

<div id="afteraction-donate-ask-source" aria-hidden="true" style="display:none;">
	<p class="afteraction-donate-ask-intro text-large2">
		{% if page.custom_fields.afteraction_donate_ask %}
			{{ page.custom_fields.afteraction_donate_ask }}
		{% else %}
			{% filter ak_text:"afteraction_donate_ask" %}Can you chip in to help stop climate change and create a more just, prosperous world? The power behind our movement comes from thousands of people like you — donate in two minutes now.{% endfilter %}
		{% endif %}
	</p>
	<p>
		<a class="afteraction-donate-ask-yes button button-large margin-bottom-large" href="https://350.org/donate">I can donate</a>
		<a class="afteraction-donate-ask-no button button-large margin-bottom-large" href="https://350.org">Not now</a>
	</p>
</div>

<script>
jQuery(document).ready(function($){
	/* only run the AJAX submission if we're sure this is an AK-hosted page */
	if ( $('html').hasClass('ak-hosted') ){
		// set up variables
		var afteractionProgressMeter = $("#afteraction-progress-meter");

		var afteraction = $("#afteraction");
		var afteractionShareSlide = $('#afteraction-share');
		var afteractionShareSlideInner = $('#afteraction-share-inner');
		var afteractionShareAskContent = $('#afteraction-share-ask-source').html();
		var afteractionShareContent = $('#afteraction-share-source').html();

		var afteractionDonateSlide = $('#afteraction-donate');
		var afteractionDonateSlideInner = $('#afteraction-donate-inner');
		var afteractionDonateAskContent = $('#afteraction-donate-ask-source').html();
		var afteractionDonateContent = $('#afteraction-donate-source').html();

		function afteractionShowShareAsk(){
			if ( afteractionShareSlideInner.html() == '' ){
				afteractionShareSlideInner.append( afteractionShareAskContent )
				afteractionShareSlide.show();
			}
			$('html, body').animate({
				scrollTop: afteractionShareSlide.offset().top
			}, 800);
			afteractionProgressMeter.fadeIn();
			$(document).trigger('domUpdated'); // tell other scripts to re-run
			$("#jump-to-form").remove();
		}

		function afteractionShowShare(){
			afteractionShareSlideInner
				.animate({opacity:0 }, 300, function(){
					$(this)
						.empty()
						.append( afteractionShareContent )
						.animate({opacity:1}, 300);
					$(document).trigger('domUpdated');
					$('html, body').animate({
						scrollTop: afteractionShareSlide.offset().top
					}, 800);
				});
		};

		function afteractionShowDonate(el){
			afteractionDonateSlide.show();
			afteractionDonateSlideInner.animate({opacity:0 }, 300, function(){
				$(this)
					.empty()
					.append( afteractionDonateAskContent )
					.animate({opacity:1}, 300);
					$(document).trigger('domUpdated');
					$('html, body').animate({
						scrollTop: afteractionDonateSlide.offset().top
					}, 800);
			});
			if ( $(el).hasClass('afteraction-share-ask-no') ){
				$("#afteraction-progress-meter-step2 .afteraction-progress-meter-dot")
					.removeClass('complete')
					.addClass('declined')
					.attr('data-icon',''); //&xE943; X
			} else {
				$("#afteraction-progress-meter-step2 .afteraction-progress-meter-dot")
					.removeClass('declined')
					.addClass('complete')
					.attr('data-icon',''); //&xE942; checkmark
			}
		};

		// re-set facebook share window pop-up
		afteraction.on('click','.button-share-facebook', function(e){
			e.preventDefault();
			var destination = jQuery(this).attr('href');
			popupWidth = 520;
			popupHeight = 350;
			// center the pop-up on the screen
			var winTop = (screen.height / 2) - (popupHeight / 2);
			var winLeft = (screen.width / 2) - (popupWidth / 2);
			window.open( destination , 'new-window-popup', 'top=' + winTop + ',left=' + winLeft + ',toolbar=0,status=0,resizable=yes,scrollbars=yes,width=' + popupWidth + ',height=' + popupHeight );
			// send Google Analytics event
			ga('send', 'event', 'scrolling-signup', 'share-facebook', window.location.pathname);
		});

		/* When the main form is submitted... */
		$('#action-form').submit(function (e) {
			// don't redirect to standard thank you page
			e.preventDefault();
			// wait 150ms for... some reason? idk, i forget
			setTimeout(function() {
				// if no errors...
				if( $(".ak-err li").length < 1) {
					$.ajax({
						method: 'POST',
						url: $('#action-form').attr('action'),
						data: $('#action-form').serialize()
					})
					.done(function(msg) {
						// send google analytics event
						ga('send', 'event', 'scrolling-signup', 'signup', window.location.pathname);
						// send FB tracker event
						if (typeof fbq === "function") {
							fbq('track', 'CompleteRegistration');
						}
						// show the share ask
						afteractionShowShareAsk();
						// if user opts to share, show share dialog
						$('.afteraction-share-ask-yes').on('click', function(){
							afteractionShowShare();
						});
						// if user opts not to share or has completed sharing, show donate ask
						afteraction.on('click','.afteraction-share-ask-no, .afteraction-share-button', function(){
							var el = $(this);
							afteractionShowDonate(el);
						});
					})
					.fail(function(){
							console.log('Error: AK AJAX submission failed.');
					});
				}
			}, 150);
		});
	}
});
</script>


{% endif %}
